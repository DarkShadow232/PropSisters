<%- include('../partials/header') %>

<% if (error && error.length > 0) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<% if (success && success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<div class="row mb-4">
  <div class="col">
    <h1 class="h3 mb-0">
      <i class="bi bi-envelope"></i> Contact Messages
    </h1>
    <p class="text-muted">Manage customer inquiries and support requests</p>
  </div>
  <div class="col-auto">
    <div class="btn-group">
      <a href="/contacts?status=all" class="btn btn-<%= currentFilter === 'all' ? 'primary' : 'outline-primary' %>">
        All
      </a>
      <a href="/contacts?status=new" class="btn btn-<%= currentFilter === 'new' ? 'warning' : 'outline-warning' %>">
        New
      </a>
      <a href="/contacts?status=read" class="btn btn-<%= currentFilter === 'read' ? 'info' : 'outline-info' %>">
        Read
      </a>
      <a href="/contacts?status=replied" class="btn btn-<%= currentFilter === 'replied' ? 'success' : 'outline-success' %>">
        Replied
      </a>
      <a href="/contacts?status=closed" class="btn btn-<%= currentFilter === 'closed' ? 'secondary' : 'outline-secondary' %>">
        Closed
      </a>
    </div>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
  <div class="col-xl-3 col-md-6">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Total Messages</h6>
            <h2 class="mb-0"><%= stats.total %></h2>
          </div>
          <div class="text-primary" style="font-size: 2.5rem;">
            <i class="bi bi-envelope"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">New Today</h6>
            <h2 class="mb-0 text-warning"><%= stats.today %></h2>
          </div>
          <div class="text-warning" style="font-size: 2.5rem;">
            <i class="bi bi-envelope-plus"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">This Week</h6>
            <h2 class="mb-0 text-info"><%= stats.thisWeek %></h2>
          </div>
          <div class="text-info" style="font-size: 2.5rem;">
            <i class="bi bi-calendar-week"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1">Unread</h6>
            <h2 class="mb-0 text-danger"><%= stats.byStatus.new || 0 %></h2>
          </div>
          <div class="text-danger" style="font-size: 2.5rem;">
            <i class="bi bi-envelope-exclamation"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Custom Filters for Contacts -->
<div class="row mb-3">
  <div class="col-md-4">
    <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, subject..." value="<%= search || '' %>">
  </div>
  <div class="col-md-2">
    <select id="statusFilter" class="form-select">
      <option value="all" <%= (status === 'all' || !status) ? 'selected' : '' %>>All Status</option>
      <option value="new" <%= status === 'new' ? 'selected' : '' %>>New</option>
      <option value="read" <%= status === 'read' ? 'selected' : '' %>>Read</option>
      <option value="replied" <%= status === 'replied' ? 'selected' : '' %>>Replied</option>
      <option value="closed" <%= status === 'closed' ? 'selected' : '' %>>Closed</option>
    </select>
  </div>
  <div class="col-md-2">
    <select id="priorityFilter" class="form-select">
      <option value="all" <%= (priority === 'all' || !priority) ? 'selected' : '' %>>All Priority</option>
      <option value="urgent" <%= priority === 'urgent' ? 'selected' : '' %>>Urgent</option>
      <option value="high" <%= priority === 'high' ? 'selected' : '' %>>High</option>
      <option value="medium" <%= priority === 'medium' ? 'selected' : '' %>>Medium</option>
      <option value="low" <%= priority === 'low' ? 'selected' : '' %>>Low</option>
    </select>
  </div>
  <div class="col-md-2">
    <select id="sortFilter" class="form-select">
      <option value="createdAt-desc" <%= (sort === 'createdAt-desc' || !sort) ? 'selected' : '' %>>Newest First</option>
      <option value="createdAt-asc" <%= sort === 'createdAt-asc' ? 'selected' : '' %>>Oldest First</option>
      <option value="name-asc" <%= sort === 'name-asc' ? 'selected' : '' %>>Name A-Z</option>
      <option value="name-desc" <%= sort === 'name-desc' ? 'selected' : '' %>>Name Z-A</option>
    </select>
  </div>
  <div class="col-md-2">
    <button id="applyFilters" class="btn btn-primary w-100">
      <i class="bi bi-funnel"></i> Apply
    </button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const priorityFilter = document.getElementById('priorityFilter');
  const sortFilter = document.getElementById('sortFilter');
  const applyFiltersBtn = document.getElementById('applyFilters');

  function applyCurrentFilters() {
    const currentSearch = searchInput.value;
    const currentStatus = statusFilter.value;
    const currentPriority = priorityFilter.value;
    const currentSort = sortFilter.value;
    
    const params = new URLSearchParams();
    if (currentSearch) params.append('search', currentSearch);
    if (currentStatus !== 'all') params.append('status', currentStatus);
    if (currentPriority !== 'all') params.append('priority', currentPriority);
    if (currentSort !== 'createdAt-desc') {
      const [sortBy, sortOrder] = currentSort.split('-');
      params.append('sortBy', sortBy);
      params.append('sortOrder', sortOrder);
    }
    
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.location.href = newUrl;
  }

  applyFiltersBtn.addEventListener('click', applyCurrentFilters);

  // Apply filters on Enter key in search input
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      applyCurrentFilters();
    }
  });

  // Auto-apply filters when other dropdowns change
  statusFilter.addEventListener('change', applyCurrentFilters);
  priorityFilter.addEventListener('change', applyCurrentFilters);
  sortFilter.addEventListener('change', applyCurrentFilters);
});
</script>

<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    <% if (contacts && contacts.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Subject</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% contacts.forEach(function(contact) { %>
              <tr class="<%= contact.status === 'new' ? 'table-warning' : '' %>">
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                      <%= contact.name.charAt(0).toUpperCase() %>
                    </div>
                    <div>
                      <div class="fw-medium"><%= contact.name %></div>
                    </div>
                  </div>
                </td>
                <td>
                  <a href="mailto:<%= contact.email %>" class="text-decoration-none">
                    <%= contact.email %>
                  </a>
                </td>
                <td>
                  <div class="text-truncate" style="max-width: 200px;" title="<%= contact.subject %>">
                    <%= contact.subject %>
                  </div>
                </td>
                <td>
                  <span class="badge bg-<%= 
                    contact.status === 'new' ? 'warning' : 
                    contact.status === 'read' ? 'info' : 
                    contact.status === 'replied' ? 'success' : 
                    'secondary' 
                  %>">
                    <%= contact.status.charAt(0).toUpperCase() + contact.status.slice(1) %>
                  </span>
                </td>
                <td>
                  <span class="badge bg-<%= 
                    contact.priority === 'urgent' ? 'danger' : 
                    contact.priority === 'high' ? 'warning' : 
                    contact.priority === 'medium' ? 'info' : 
                    'secondary' 
                  %>">
                    <%= contact.priority.charAt(0).toUpperCase() + contact.priority.slice(1) %>
                  </span>
                </td>
                <td>
                  <div class="text-muted small">
                    <%= new Date(contact.createdAt).toLocaleDateString() %>
                  </div>
                  <div class="text-muted small">
                    <%= new Date(contact.createdAt).toLocaleTimeString() %>
                  </div>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="/contacts/<%= contact._id %>" class="btn btn-outline-primary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="mailto:<%= contact.email %>?subject=Re: <%= encodeURIComponent(contact.subject) %>" class="btn btn-outline-success" title="Reply">
                      <i class="bi bi-reply"></i>
                    </a>
                    <button class="btn btn-outline-danger" onclick="deleteContact('<%= contact._id %>')" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if (pagination && pagination.pages > 1) { %>
        <div class="card-footer">
          <nav aria-label="Contact messages pagination">
            <ul class="pagination pagination-sm mb-0 justify-content-center">
              <% if (pagination.current > 1) { %>
                <li class="page-item">
                  <a class="page-link" href="?page=<%= pagination.current - 1 %>&status=<%= currentFilter %>&search=<%= search || '' %>">
                    <i class="bi bi-chevron-left"></i>
                  </a>
                </li>
              <% } %>
              
              <% for (let i = Math.max(1, pagination.current - 2); i <= Math.min(pagination.pages, pagination.current + 2); i++) { %>
                <li class="page-item <%= i === pagination.current ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %>&status=<%= currentFilter %>&search=<%= search || '' %>">
                    <%= i %>
                  </a>
                </li>
              <% } %>
              
              <% if (pagination.current < pagination.pages) { %>
                <li class="page-item">
                  <a class="page-link" href="?page=<%= pagination.current + 1 %>&status=<%= currentFilter %>&search=<%= search || '' %>">
                    <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
              <% } %>
            </ul>
          </nav>
        </div>
      <% } %>
    <% } else { %>
      <div class="text-center py-5">
        <div class="text-muted mb-3">
          <i class="bi bi-envelope" style="font-size: 3rem;"></i>
        </div>
        <h5 class="text-muted">No contact messages found</h5>
        <p class="text-muted">There are no contact messages matching your current filters.</p>
      </div>
    <% } %>
  </div>
</div>

<script>
function deleteContact(contactId) {
  if (confirm('Are you sure you want to delete this contact message? This action cannot be undone.')) {
    fetch(`/api/admin/contacts/${contactId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Failed to delete contact message: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while deleting the contact message.');
    });
  }
}
</script>

<%- include('../partials/footer') %>
