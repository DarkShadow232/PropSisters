<%- include('../partials/header') %>

<% if (error && error.length > 0) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<% if (success && success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success[0] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% } %>

<div class="row mb-4">
  <div class="col">
    <h1 class="h3 mb-0">
      <i class="bi bi-tools"></i> Finish Request Details
    </h1>
    <p class="text-muted">View and manage finish request</p>
  </div>
  <div class="col-auto">
    <a href="/finish-requests" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to Requests
    </a>
  </div>
</div>

<% if (request) { %>
<div class="row">
  <!-- Request Details -->
  <div class="col-lg-8">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Request #<%= (request.id || request._id || 'Unknown').toString().substring(0, 8) %>...</h5>
          <div>
            <span class="badge bg-<%= request.status === 'pending' ? 'warning' : request.status === 'reviewed' ? 'info' : request.status === 'in-progress' ? 'primary' : request.status === 'completed' ? 'success' : 'danger' %>">
              <%= request.status.charAt(0).toUpperCase() + request.status.slice(1) %>
            </span>
            <span class="badge bg-<%= request.priority === 'urgent' ? 'dark' : request.priority === 'high' ? 'danger' : request.priority === 'medium' ? 'warning' : 'success' %> ms-2">
              <%= request.priority.charAt(0).toUpperCase() + request.priority.slice(1) %>
            </span>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-muted">Request Type</h6>
            <p class="mb-3"><%= request.requestType.charAt(0).toUpperCase() + request.requestType.slice(1) %></p>
            
            <h6 class="text-muted">Property Type</h6>
            <p class="mb-3"><%= request.propertyType.charAt(0).toUpperCase() + request.propertyType.slice(1) %></p>
            
            <h6 class="text-muted">Budget Range</h6>
            <p class="mb-3">
              <% if (request.budget === 'under-10k') { %>
                Under 10,000 EGP
              <% } else if (request.budget === '10k-25k') { %>
                10,000 - 25,000 EGP
              <% } else if (request.budget === '25k-50k') { %>
                25,000 - 50,000 EGP
              <% } else if (request.budget === '50k-100k') { %>
                50,000 - 100,000 EGP
              <% } else if (request.budget === '100k-plus') { %>
                100,000+ EGP
              <% } else { %>
                <%= request.budget %>
              <% } %>
            </p>
            
            <h6 class="text-muted">Timeline</h6>
            <p class="mb-3">
              <% if (request.timeline === 'asap') { %>
                ASAP
              <% } else if (request.timeline === '1-month') { %>
                1 Month
              <% } else if (request.timeline === '2-3-months') { %>
                2-3 Months
              <% } else if (request.timeline === '3-6-months') { %>
                3-6 Months
              <% } else if (request.timeline === 'flexible') { %>
                Flexible
              <% } else { %>
                <%= request.timeline %>
              <% } %>
            </p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Location</h6>
            <p class="mb-3"><%= request.location %></p>
            
            <h6 class="text-muted">Contact Phone</h6>
            <p class="mb-3">
              <a href="tel:<%= request.contactPhone %>" class="text-decoration-none">
                <i class="bi bi-telephone"></i> <%= request.contactPhone %>
              </a>
            </p>
            
            <h6 class="text-muted">Created At</h6>
            <p class="mb-3"><%= request.createdAt ? new Date(request.createdAt).toLocaleString() : 'N/A' %></p>
            
            <h6 class="text-muted">Last Updated</h6>
            <p class="mb-3"><%= request.updatedAt ? new Date(request.updatedAt).toLocaleString() : 'N/A' %></p>
          </div>
        </div>
        
        <h6 class="text-muted">Description</h6>
        <div class="bg-light p-3 rounded mb-4">
          <p class="mb-0"><%= request.description %></p>
        </div>
        
        <% if (request.attachments && request.attachments.length > 0) { %>
        <h6 class="text-muted">Attachments</h6>
        <div class="row">
          <% request.attachments.forEach(attachment => { %>
          <div class="col-md-4 mb-3">
            <div class="card">
              <% if (attachment.mimetype && attachment.mimetype.startsWith('image/')) { %>
                <img src="/uploads/finish-requests/<%= attachment.filename %>" class="card-img-top" alt="Attachment" style="height: 150px; object-fit: cover;">
              <% } else { %>
                <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 150px;">
                  <i class="bi bi-file-earmark-text fs-1 text-muted"></i>
                </div>
              <% } %>
              <div class="card-body p-2">
                <small class="text-muted d-block"><%= attachment.originalName %></small>
                <small class="text-muted">Size: <%= (attachment.size / 1024).toFixed(1) %> KB</small>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Notes Section -->
    <% if (request.notes && request.notes.length > 0) { %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Notes & Updates</h5>
      </div>
      <div class="card-body">
        <% request.notes.forEach(note => { %>
        <div class="border-start border-3 border-primary ps-3 mb-3">
          <p class="mb-1"><%= note.note %></p>
          <small class="text-muted">
            <i class="bi bi-clock"></i> <%= new Date(note.addedAt).toLocaleString() %>
          </small>
        </div>
        <% }) %>
      </div>
    </div>
    <% } %>
  </div>
  
  <!-- Admin Actions -->
  <div class="col-lg-4">
    <!-- Quick Actions -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="tel:<%= request.contactPhone %>" class="btn btn-success">
            <i class="bi bi-telephone"></i> Call Customer
          </a>
          <a href="mailto:<%= request.userEmail %>" class="btn btn-primary">
            <i class="bi bi-envelope"></i> Email Customer
          </a>
          <button class="btn btn-info" onclick="sendWhatsApp('<%= request.contactPhone %>')">
            <i class="bi bi-whatsapp"></i> WhatsApp
          </button>
          <button class="btn btn-warning" onclick="copyRequestInfo()">
            <i class="bi bi-clipboard"></i> Copy Request Info
          </button>
        </div>
      </div>
    </div>

    <!-- Update Request Form -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Update Request</h5>
      </div>
      <div class="card-body">
        <form id="updateRequestForm">
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
              <option value="pending" <%= request.status === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="reviewed" <%= request.status === 'reviewed' ? 'selected' : '' %>>Reviewed</option>
              <option value="in-progress" <%= request.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
              <option value="completed" <%= request.status === 'completed' ? 'selected' : '' %>>Completed</option>
              <option value="cancelled" <%= request.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="priority" class="form-label">Priority</label>
            <select class="form-select" id="priority" name="priority">
              <option value="low" <%= request.priority === 'low' ? 'selected' : '' %>>Low</option>
              <option value="medium" <%= request.priority === 'medium' ? 'selected' : '' %>>Medium</option>
              <option value="high" <%= request.priority === 'high' ? 'selected' : '' %>>High</option>
              <option value="urgent" <%= request.priority === 'urgent' ? 'selected' : '' %>>Urgent</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="estimatedCost" class="form-label">Estimated Cost (EGP)</label>
            <input type="number" class="form-control" id="estimatedCost" name="estimatedCost" value="<%= request.estimatedCost || '' %>">
          </div>
          
          <div class="mb-3">
            <label for="actualCost" class="form-label">Actual Cost (EGP)</label>
            <input type="number" class="form-control" id="actualCost" name="actualCost" value="<%= request.actualCost || '' %>">
          </div>
          
          <div class="mb-3">
            <label for="startDate" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="startDate" name="startDate" value="<%= request.startDate ? new Date(request.startDate).toISOString().split('T')[0] : '' %>">
          </div>
          
          <div class="mb-3">
            <label for="completionDate" class="form-label">Completion Date</label>
            <input type="date" class="form-control" id="completionDate" name="completionDate" value="<%= request.completionDate ? new Date(request.completionDate).toISOString().split('T')[0] : '' %>">
          </div>
          
          <div class="mb-3">
            <label for="adminNotes" class="form-label">Admin Notes</label>
            <textarea class="form-control" id="adminNotes" name="adminNotes" rows="3" placeholder="Add notes about this request..."><%= request.adminNotes || '' %></textarea>
          </div>
          
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-check-circle"></i> Update Request
          </button>
        </form>
      </div>
    </div>
    
    <!-- User Information -->
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0">Customer Information</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <strong>Name:</strong><br>
          <span class="text-muted"><%= request.userName || 'N/A' %></span>
        </div>
        <div class="mb-3">
          <strong>Email:</strong><br>
          <a href="mailto:<%= request.userEmail %>" class="text-decoration-none">
            <%= request.userEmail %>
          </a>
        </div>
        <div class="mb-3">
          <strong>Phone:</strong><br>
          <a href="tel:<%= request.contactPhone %>" class="text-decoration-none">
            <i class="bi bi-telephone"></i> <%= request.contactPhone %>
          </a>
          <% if (request.countryCode) { %>
            <br><small class="text-muted">Country: <%= request.countryCode %></small>
          <% } %>
        </div>
        <div class="mb-3">
          <strong>Location:</strong><br>
          <span class="text-muted"><%= request.location %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Update request form
document.getElementById('updateRequestForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const updateData = {
    status: formData.get('status'),
    priority: formData.get('priority'),
    estimatedCost: parseFloat(formData.get('estimatedCost')) || null,
    actualCost: parseFloat(formData.get('actualCost')) || null,
    startDate: formData.get('startDate') || null,
    completionDate: formData.get('completionDate') || null,
    adminNotes: formData.get('adminNotes')
  };
  
  try {
    const response = await fetch(`/finish-requests/<%= request.id || request._id %>`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(updateData),
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('Request updated successfully!');
      location.reload();
    } else {
      alert('Failed to update request: ' + data.error);
    }
  } catch (error) {
    console.error('Error updating request:', error);
    alert('Error updating request.');
  }
});

// WhatsApp function
function sendWhatsApp(phone) {
  const message = `Hello! This is regarding your finish request #<%= (request.id || request._id || 'Unknown').toString().substring(0, 8) %>. We would like to discuss the details with you.`;
  const whatsappUrl = `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

// Copy request info function
function copyRequestInfo() {
  const requestInfo = `Finish Request #<%= (request.id || request._id || 'Unknown').toString().substring(0, 8) %>
Customer: <%= request.userName %>
Email: <%= request.userEmail %>
Phone: <%= request.contactPhone %>
Type: <%= request.requestType %>
Property: <%= request.propertyType %>
Budget: <%= request.budget %>
Timeline: <%= request.timeline %>
Location: <%= request.location %>
Status: <%= request.status %>
Priority: <%= request.priority %>
Description: <%= request.description %>`;
  
  navigator.clipboard.writeText(requestInfo).then(() => {
    alert('Request information copied to clipboard!');
  }).catch(() => {
    alert('Failed to copy to clipboard');
  });
}
</script>

<% } else { %>
<div class="alert alert-warning">
  <i class="bi bi-exclamation-triangle"></i> Finish request not found.
</div>
<% } %>

<%- include('../partials/footer') %>
